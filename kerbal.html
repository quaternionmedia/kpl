<!DOCTYPE html>
<meta charset="utf-8">
<style>
code {outline: 1px solid #ccc; padding: 5px; margin: 5px;
  white-space: pre-line;}
.string { color: green; }
.number { color: darkorange; }
.boolean { color: blue; }
.null { color: magenta; }
.key { color: red; }
</style>
<script src="deps/smoothie.js"></script>

<body onload="createTimeline()">
  <canvas id="canvas" style="width:100%; height:200px"></canvas>
  <div class="control"><label class="slider" for="input1">Scroll speed</label><input id="input1" type="range" min="1" max="100" oninput="updateScroll()"></div>
  <input id="shInput"><button onclick="sendText()">sh</button>
  <div id="shText"></div>
    <script>
    var smooth, chart;
    var options = { responsive: true,
                    millisPerPixel:80,
                    tooltip: true,}
    var canvas = document.getElementById('canvas');
    var shText = document.getElementById('shText');
    var shInput = document.getElementById('shInput');
    const reader = new FileReader();
    reader.addEventListener('loadend', (e) => {
      const text = e.srcElement.result;
      console.log(text);
        shText.innerHTML = text;
    });
    var chartLoaded = false;
    var wsurl = "ws://" + window.location.hostname + ":" + window.location.port;
    var socket;
    var shSocket;
    var newX = [];
    var newY = [];
    var newZ = [];
    var newT = [];
    var oldT = [];
    var chartLength = 0;
    var chartMax = 100;
    let average = (array) => array.reduce((a, b) => a + b, 0) / array.length;

    function syntaxHighlight(json) {
        json = JSON.parse(json);      console.log('highlighting', typeof json);
        if (typeof json != 'string') {
             json = JSON.stringify(json, null, 4);
        }

        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/, /g, ', \n');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            var cls = 'number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'key';
                } else {
                    cls = 'string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'boolean';
            } else if (/null/.test(match)) {
                cls = 'null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }

    function connectToWebsocket() {
      socket = new WebSocket(wsurl + '/krpc');
      socket.addEventListener('open', function (event) {
        socket.send('Hello Server!');
      });

      socket.addEventListener('message', function (event) {
        // console.log('Message from server ', event.data);
        updatePosition(JSON.parse(event.data));
      });
      shSocket = new WebSocket(wsurl + '/wrap');
      shSocket.addEventListener('message', function (event) {
        // console.log('new sh message', event.data);
      // reader.readAsText(event.data);
      shText.innerHTML = '';
      shText.appendChild(document.createElement('code')).innerHTML = syntaxHighlight(JSON.parse(event.data));
});
    }
  connectToWebsocket();

  function sendText() {
    console.log("sending value to server", shInput.value);
    shSocket.send(shInput.value);
  }
  var posX = new TimeSeries();
  var posY = new TimeSeries();
  var posZ = new TimeSeries();
  var input1 = document.getElementById("input1");
  var t0 = new Date().getTime();

  function createTimeline() {
    smooth = new SmoothieChart(options);
    smooth.addTimeSeries(posX, { strokeStyle: 'rgba(255, 0, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
    smooth.addTimeSeries(posY, { strokeStyle: 'rgba(0, 255, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
    smooth.addTimeSeries(posZ, { strokeStyle: 'rgba(0, 0, 255, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
    smooth.streamTo(document.getElementById("canvas"), 500);

    console.log('creating chart!');
    chartLoaded = true;

  }

  function updatePosition(pos) {
    if (chartLoaded) {
      // console.log("updating position", pos[0]);
      var p = pos["pos"];
      t = new Date().getTime();
      // console.log("new position! ", p);
      posX.append(t, p[0]);
      posY.append(t, p[1]);
      posZ.append(t, p[2]);

      newT.push(t);
      newX.push(p[0]);
      newY.push(p[1]);
      newZ.push(p[2]);

    }
  }
  function updateScroll() {
    smooth.options['millisPerPixel']=input1.value;

  }


</script>
</body>

</html>
