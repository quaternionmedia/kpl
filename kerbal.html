<!DOCTYPE html>
<meta charset="utf-8">

<script src="deps/smoothie.js"></script>
<script src="deps/autobahn.js"></script>

<link href="deps/c3.css" rel="stylesheet">
<script src="deps/d3.js" charset="utf-8"></script>
<script src="deps/c3.js"></script>
<body onload="createTimeline()">
  <canvas id="canvas" style="width:100%; height:200px"></canvas>
  <div class="control"><label class="slider" for="input1">Scroll speed</label><input id="input1" type="range" min="1" max="100" oninput="updateScroll()"></div>
  <div class='chart'>
    <div id='chart'></div>
    <script>
    var smooth, chart;
    var options = { responsive: true,
                    millisPerPixel:80,
                    tooltip: true,}
    var canvas = document.getElementById('canvas');
    var chartLoaded = false;
    var wsurl = "ws://" + window.location.hostname + ":" + window.location.port + "/krpc";
    var socket;
    var newX = [];
    var newY = [];
    var newZ = [];
    var newT = [];
    var oldT = [];
    var chartLength = 0;
    var chartMax = 100;
    let average = (array) => array.reduce((a, b) => a + b, 0) / array.length;


    function connectToWebsocket() {
      socket = new WebSocket(wsurl);
      socket.addEventListener('open', function (event) {
        socket.send('Hello Server!');
      });

      socket.addEventListener('message', function (event) {
        console.log('Message from server ', event.data);
        updatePosition(JSON.parse(event.data));
      });
    }
  connectToWebsocket();
  var posX = new TimeSeries();
  var posY = new TimeSeries();
  var posZ = new TimeSeries();
  var input1 = document.getElementById("input1");
  var t0 = new Date().getTime();

  function createTimeline() {
    smooth = new SmoothieChart(options);
    smooth.addTimeSeries(posX, { strokeStyle: 'rgba(255, 0, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
    smooth.addTimeSeries(posY, { strokeStyle: 'rgba(0, 255, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
    smooth.addTimeSeries(posZ, { strokeStyle: 'rgba(0, 0, 255, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
    smooth.streamTo(document.getElementById("canvas"), 500);

    console.log('creating chart!');
    chartLoaded = true;

  }

  function updatePosition(pos) {
    if (chartLoaded) {
      console.log("updating position", pos[0]);
      var p = pos["pos"];
      t = new Date().getTime();
      // console.log("new position! ", p);
      posX.append(t, p[0]);
      posY.append(t, p[1]);
      posZ.append(t, p[2]);

      newT.push(t);
      newX.push(p[0]);
      newY.push(p[1]);
      newZ.push(p[2]);

    }
  }
  function updateScroll() {
    smooth.options['millisPerPixel']=input1.value;

  }


</script>
</body>

</html>
