<!DOCTYPE html>
<meta charset="utf-8">

<script src="deps/smoothie.js"></script>
<script src="deps/autobahn.js"></script>

<link href="deps/c3.css" rel="stylesheet">
<script src="deps/d3.js" charset="utf-8"></script>
<script src="deps/c3.js"></script>
<body onload="createTimeline()">
  <canvas id="canvas" style="width:100%; height:200px"></canvas>
  <!-- <div class="control"><label class="slider" for="input1">Scroll speed</label><input id="input1" type="range" min="1" max="100" oninput="updateScroll()"></div> -->
  <div class='chart'>
    <div id='chart'></div>
    <script>
    var smooth, chart;
    var options = {responsive: true, millisPerPixel:10}
    var canvas = document.getElementById('canvas');
    var chartLoaded = false;
    var wsuri = "ws://" + window.location.hostname + ":7777/ws";
    var connection;
    var newX = [];
    var newY = [];
    var newZ = [];
    var newT = [];
    var oldT = [];
    var chartLength = 0;
    var chartMax = 10;
    let average = (array) => array.reduce((a, b) => a + b, 0) / array.length;


    function connectToCrossbar() {
      connection = new autobahn.Connection({
        url: wsuri,
        realm: "realm1"
      }
    );
    connection.onopen = function (session, details) {
      console.log("Connected: ", details);
      session.subscribe('local.krpc.position', updatePosition);
    }
    connection.open();

  }
  var posX = new TimeSeries();
  var posY = new TimeSeries();
  var posZ = new TimeSeries();
  var input1 = document.getElementById("input1");
  var t0 = new Date().getTime();

  function createTimeline() {
    var smooth = new SmoothieChart(options);
    smooth.addTimeSeries(posX, { strokeStyle: 'rgba(255, 0, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
    smooth.addTimeSeries(posY, { strokeStyle: 'rgba(0, 255, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
    smooth.addTimeSeries(posZ, { strokeStyle: 'rgba(0, 0, 255, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
    smooth.streamTo(document.getElementById("canvas"), 500);

    console.log('creating chart!');

    chart = c3.generate({
      data: {
        x: 't',
        //        xFormat: '%Y%m%d', // 'xFormat' can be used as custom format of 'x'
        columns: [
          ['t'],
          ['x'],
          ['y'],
          ['z'],
          //            ['x', '20130101', '20130102', '20130103', '20130104', '20130105', '20130106'],
          // ['data1', 30, 200, 100, 400, 150, 250],
          // ['data2', 130, 340, 200, 500, 250, 350]
        ],
        colors: {
          x: '#ff0000',
          y: '#00ff00',
          z: '#0000ff',
        },
      },
      axis: {
        x: {
          // min: t0,
          type: 'timeseries',
          // zoom: {
          //   type: 'scroll',
          //   rescale: false
          // }            // tick: {
          //     format: '%Y-%m-%d'
          // }
        }
      },

    });
    chartLoaded = true;

  }

  function updatePosition(pos) {
    if (chartLoaded) {
      var p = pos[0];
      t = new Date().getTime();
      // console.log("new position! ", p);
      posX.append(t, p[0]);
      posY.append(t, p[1]);
      posZ.append(t, p[2]);

      newT.push(t);
      newX.push(p[0]);
      newY.push(p[1]);
      newZ.push(p[2]);

    }
  }
  // function updateScroll() {
  //   options['millisPerPixel']=input1.value;
  //
  // }

  function updateData() {
    console.log('flowing ', newT[0], newX[0], newY[0], newZ[0]);
    chart.flow({columns:[
      ['t', newT[0]], // Math.floor(newT.length/2)]],
      ['x', newX[0]], //average(newX)],
      ['y', newY[0]],
      ['z', newZ[0]]
    ],

    length : chartLength++ < chartMax ? 0 : 1,
    // axis: { x : oldT[0]},
  }
);
// chart.axis.min({ x : oldT[0]});
// newData = [[], [], [], []];

oldT.push(newT[0]);
console.log('pushing ', oldT[0]);
if (oldT.length >= chartMax) {
  console.log('shifting oldT', oldT.length, oldT);
  oldT.shift();
}
newX = [];
newY = [];
newZ = [];
newT = [];
}
connectToCrossbar();
setInterval(updateData, 1000);


</script>
</body>

</html>
